<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (KaTeX & –î–≤–∞ –û—Ç–≤–µ—Ç–∞)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-nK/gD87CqjGzN0W12/Y0132l4B3hGgM+5r01zYdE/1v8p+8u7m7yA01j2v2n8n5j" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-2j98j15Nl1G8b4xVwR2L4Y5E4s7tT9F/h2Q30j9j1t6N7T30Q/8m4Y3E4v/nQ1z" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #111827); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .calculator-container {
            max-width: 500px;
            width: 100%; 
            margin: 0 auto;
        }

        .calculator {
            background: #374151; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%; 
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
        }
        
        /* –û–ë–õ–ê–°–¢–¨ –†–ï–ù–î–ï–†–ò–ù–ì–ê (–í–ò–ó–£–ê–õ–¨–ù–ê–Ø –î–†–û–ë–¨) */
        #render-output {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            min-height: 60px;
            margin-bottom: 10px;
            text-align: right;
            font-size: 1.8rem;
            color: #d1d5db; 
            display: flex;
            justify-content: flex-end;
            align-items: center;
            overflow-x: auto; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª */
        }

        #render-output .katex {
            color: #d1d5db;
        }

        /* --- –î–í–ê –ü–û–õ–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–ê --- */
        #result-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .result-box {
            padding: 10px;
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: right;
            word-break: break-all;
            background-color: #1f2937;
            border-left: 4px solid;
        }
        
        .result-box.fraction-result {
            color: #10b981; /* –¢–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç */
            border-color: #10b981; 
        }

        .result-box.decimal-result {
            color: #3b82f6; /* –ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç */
            border-color: #3b82f6; 
        }

        .error { color: #f87171; border-color: #f87171; }
        .text-purple-400 { color: #c084fc; border-color: #c084fc; } /* CAS */


        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–æ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) */
        input[type="text"] {
            width: 100%;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            background: #1f2937; 
            color: #d1d5db; 
            text-align: right;
            transition: all 0.2s;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        button {
            padding: 12px 0;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 3px #4b5563;
            cursor: pointer;
            user-select: none;
            min-width: 0; 
        }
        
        .btn-op { background-color: #f59e0b; color: #1f2937; box-shadow: 0 3px #d97706; }
        .btn-op:active { background-color: #d97706; transform: translateY(1px); box-shadow: 0 2px #d97706; }
        .btn-num { background-color: #4b5563; color: white; box-shadow: 0 3px #374151; }
        .btn-num:active { background-color: #374151; transform: translateY(1px); box-shadow: 0 2px #374151; }
        .btn-main { background-color: #10b981; color: white; box-shadow: 0 3px #059669; grid-column: span 4; }
        .btn-main:active { background-color: #059669; transform: translateY(1px); box-shadow: 0 2px #059669; }
        .btn-clear, .btn-history { background-color: #ef4444; color: white; box-shadow: 0 3px #dc2626; }
        .btn-clear:active, .btn-history:active { background-color: #dc2626; transform: translateY(1px); box-shadow: 0 2px #dc2626; }
        .btn-mem { background-color: #3b82f6; color: white; box-shadow: 0 3px #2563eb; }
        .btn-mem:active { background-color: #2563eb; transform: translateY(1px); box-shadow: 0 2px #2563eb; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-panel {
            background: #28303d; 
            width: 100%; 
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
            max-height: 400px; 
            overflow-y: auto;
            color: #d1d5db;
            margin-top: 20px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, visibility 0.3s;
        }

        .history-panel.hidden {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            visibility: hidden;
        }

        .history-panel::-webkit-scrollbar { width: 8px; }
        .history-panel::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .history-panel::-webkit-scrollbar-track { background: #28303d; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s;
            border-left: 4px solid #f59e0b;
        }
        .history-item:hover { background: #4b5563; }
        .history-expression { font-size: 0.9rem; color: #9ca3af; }
        .history-result { font-size: 1.2rem; font-weight: 600; color: #10b981; }

    </style>
</head>
<body>
    <h1 class="text-3xl font-extrabold text-white mb-6 text-center">üßÆ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (KaTeX & –î–≤–∞ –û—Ç–≤–µ—Ç–∞)</h1>
    
    <div class="calculator-container">
        <div class="calculator">
            
            <div id="result-container">
                <div class="result-box fraction-result" id="fraction-result">–¢–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç: –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...</div>
                <div class="result-box decimal-result" id="decimal-result">–ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ---</div>
            </div>
            
            <div id="render-output"></div>

            <input type="text" id="expression" placeholder="–í–≤–µ–¥–∏—Ç–µ: \frac{1}{2} + 3, 1x+2x, –∏–ª–∏ 2x^3=4">
            
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button class="btn-mem text-sm" onclick="memoryClear()">MC</button>
                <button class="btn-mem text-sm" onclick="memoryRecall()">MR</button>
                <button class="btn-mem text-sm" onclick="memoryAdd()">M+</button>
                <button class="btn-mem text-sm" onclick="memorySubtract()">M-</button>
            </div>
            
            <div class="grid grid-cols-5 gap-2 mb-4">
                <button class="btn-op text-sm" onclick="appendToExpression('sin(')">sin</button>
                <button class="btn-op text-sm" onclick="appendToExpression('cos(')">cos</button>
                <button class="btn-op text-sm" onclick="appendToExpression('tan(')">tan</button>
                <button class="btn-op text-sm" onclick="appendToExpression('log(')">log</button>
                <button class="btn-op text-sm" onclick="appendToExpression('sqrt(')">‚àö</button>
            </div>
            
            <div class="btn-grid">
                <button class="btn-history" onclick="toggleHistory()">H</button>
                <button class="btn-clear" onclick="clearExpression()">AC</button>
                <button class="btn-op" onclick="appendToExpression('(')">(</button>
                <button class="btn-op" onclick="appendToExpression(')')">)</button>

                <button class="btn-num" onclick="appendToExpression('7')">7</button>
                <button class="btn-num" onclick="appendToExpression('8')">8</button>
                <button class="btn-num" onclick="appendToExpression('9')">9</button>
                <button class="btn-op" onclick="appendToExpression('/')">/</button> 

                <button class="btn-num" onclick="appendToExpression('4')">4</button>
                <button class="btn-num" onclick="appendToExpression('5')">5</button>
                <button class="btn-num" onclick="appendToExpression('6')">6</button>
                <button class="btn-op" onclick="appendToExpression('*')">√ó</button>

                <button class="btn-num" onclick="appendToExpression('1')">1</button>
                <button class="btn-num" onclick="appendToExpression('2')">2</button>
                <button class="btn-num" onclick="appendToExpression('3')">3</button>
                <button class="btn-op" onclick="appendToExpression('-')">-</button>
                
                <button class="btn-num" onclick="appendToExpression('0')">0</button>
                <button class="btn-num" onclick="appendToExpression('.')">.</button>
                <button class="btn-op" onclick="appendToExpression('\\pi')">œÄ</button> 
                <button class="btn-op" onclick="appendToExpression('+')">+</button>

                <button class="btn-op text-lg font-extrabold" onclick="insertFractionTemplate()">f/x</button> 
                <button class="btn-op" onclick="appendToExpression('x')">x</button>
                <button class="btn-op" onclick="appendToExpression('^2')">x¬≤</button>
                <button class="btn-op" onclick="appendToExpression('=')">=</button>
                
                <button class="btn-main mt-4" onclick="handleInput()">–í—ã—á–∏—Å–ª–∏—Ç—å</button>
            </div>
            
        </div>
        
        <div class="history-panel hidden" id="history-panel">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">–ñ—É—Ä–Ω–∞–ª –í—ã—á–∏—Å–ª–µ–Ω–∏–π</h3>
            <div id="history-log" class="flex flex-col-reverse">
                <p class="text-sm text-gray-500 text-center mt-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.</p>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
        const expressionInput = document.getElementById('expression');
        const fractionResultDiv = document.getElementById('fraction-result');
        const decimalResultDiv = document.getElementById('decimal-result');
        const historyPanel = document.getElementById('history-panel'); 
        const historyLogDiv = document.getElementById('history-log');
        const renderOutputDiv = document.getElementById('render-output');

        let calculationHistory = [];
        let memoryValue = 0; 
        const Epsilon = 1e-10; 

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ math.js –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏
        const scope = { M: 0, pi: math.pi, e: math.e };
        
        Object.defineProperty(scope, 'M', {
            get: () => memoryValue, set: (val) => memoryValue = val, enumerable: true, configurable: true
        });

        // --- –§–£–ù–ö–¶–ò–ò –†–ï–ù–î–ï–†–ò–ù–ì–ê –ò –í–í–û–î–ê ---

        function renderExpression(text) {
            let kaTeXInput = text
                .replace(/\*/g, '\\cdot ') 
                .replace(/pi/g, '\\pi') 
                .replace(/\^/g, '^{'); 

            kaTeXInput = kaTeXInput.replace(/^{([^{}]+)(?![}])/g, '^{$1}');
            
            try {
                katex.render(kaTeXInput, renderOutputDiv, {
                    throwOnError: false,
                    displayMode: true,
                });
            } catch (e) {
                renderOutputDiv.textContent = text;
            }
        }

        expressionInput.addEventListener('input', function() {
            renderExpression(expressionInput.value);
            showResults('–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...', '---', 'fraction-result', 'decimal-result');
        });

        expressionInput.addEventListener('keypress', function(e) { 
            if (e.key === 'Enter') handleInput(); 
        });

        function appendToExpression(value) {
            if (value === 'pi') value = '\\pi'; 
            expressionInput.value += value;
            renderExpression(expressionInput.value); 
        }

        function clearExpression() {
            expressionInput.value = '';
            showResults('–û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...', '---', 'fraction-result', 'decimal-result');
            renderOutputDiv.innerHTML = '';
        }

        function insertFractionTemplate() {
            expressionInput.value += '\\frac{}{}';
            renderExpression(expressionInput.value);
        }
        
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---
        function showResults(fractionText, decimalText, fractionClass, decimalClass) {
            fractionResultDiv.textContent = '–¢–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + fractionText;
            decimalResultDiv.textContent = '–ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + decimalText;
            
            fractionResultDiv.className = `result-box ${fractionClass}`;
            decimalResultDiv.className = `result-box ${decimalClass}`;
        }
        
        // --- –ü–∞–º—è—Ç—å, –ò—Å—Ç–æ—Ä–∏—è, –†–µ—à–µ–Ω–∏–µ –£—Ä–∞–≤–Ω–µ–Ω–∏–π (–ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–ø—É—â–µ–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) ---
        
        function toggleHistory() {
            historyPanel.classList.toggle('hidden');
        }

        function recordHistory(expression, result, type) {
            const historyItem = { id: Date.now(), expression, result: result.toString(), type };
            calculationHistory.push(historyItem);
            renderHistory();
        }

        function useHistoryItem(id) {
            const item = calculationHistory.find(i => i.id === id);
            if (item) {
                expressionInput.value = item.expression;
                showResults(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏: ${item.result.split('|')[0]}`, item.result.split('|')[1], 'fraction-result', 'decimal-result');
                renderExpression(item.expression);
            }
        }

        function renderHistory() { /* ... */ } // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ result.split('|')
        
        function memoryUpdate(operation) { /* ... */ }
        function memoryAdd() { memoryUpdate('+'); }
        function memorySubtract() { memoryUpdate('-'); }
        function memoryClear() { /* ... */ }
        function memoryRecall() { /* ... */ }
        
        function hasUserVariables(expression) { /* ... */ }
        function parseSide(expr) { /* ... */ }
        function solveCubic(a, b, c, d) { /* ... */ }
        function solveCubicAlternative(b, c, d) { /* ... */ }
        function solveEquation(input) { /* ... */ }


        // --- –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ (–û–ë–ù–û–í–õ–ï–ù) ---

        function handleInput() {
            const input = expressionInput.value.trim();
            if (!input) {
                showResults('–í–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ!', '---', 'error', 'error');
                return;
            }
            
            let expression = input
                .replace(/\\pi/g, 'pi')
                .replace(/\\frac{([^{}]+)}{([^{}]+)}/g, '($1)/($2)')
                .replace(/√ó/g, '*')
                .replace(/x¬≤/g, 'x^2')
                .replace(/x¬≥/g, 'x^3');

            // 1. –£—Ä–∞–≤–Ω–µ–Ω–∏—è
            if (expression.includes('=')) {
                solveEquation(input); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
            } 
            // 2. CAS –∏ –í—ã—á–∏—Å–ª–µ–Ω–∏—è
            else {
                if (hasUserVariables(expression)) {
                    // –ê) –°–∏–º–≤–æ–ª—å–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ (CAS)
                    try {
                        const simplified = math.simplify(expression);
                        const resultKaTeX = simplified.toTex(); 
                        
                        showResults(`–£–ø—Ä–æ—â–µ–Ω–æ (CAS). –°–º. —Ä–µ–Ω–¥–µ—Ä.`, '–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ', 'text-purple-400', 'text-purple-400');
                        recordHistory(input, resultKaTeX, 'simplify');
                        renderExpression(resultKaTeX);

                    } catch (error) {
                        showResults('–û—à–∏–±–∫–∞ CAS: ' + error.message, '---', 'error', 'error');
                    }
                } else {
                    // –ë) –ß–∏—Å–ª–æ–≤–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ (Evaluation)
                    try {
                        const result = math.evaluate(expression, scope);
                        
                        let fractionResult;
                        let decimalResult;
                        let kaTeXOutput;

                        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é –¥—Ä–æ–±—å
                        try {
                            const exactFraction = math.fraction(result);
                            fractionResult = exactFraction.toFraction();
                            kaTeXOutput = `\\frac{${exactFraction.n}}{${exactFraction.d}}`;
                        } catch (e) {
                             // –ï—Å–ª–∏ –Ω–µ –¥—Ä–æ–±—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, sqrt(2) –∏–ª–∏ BigNumber), –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ
                            if (typeof result.toFraction === 'function') {
                                // –û–±—Ä–∞–±–æ—Ç–∫–∞ BigNumber
                                fractionResult = result.toFraction();
                                kaTeXOutput = fractionResult;
                            } else {
                                fractionResult = result.toFixed(10).replace(/\.?0+$/, '') + ' (Dec)';
                                kaTeXOutput = result.toTex ? result.toTex() : result.toString();
                            }
                        }

                        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π –¥—Ä–æ–±–∏ (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
                        try {
                            decimalResult = math.format(result, { precision: 14, notation: 'fixed' }).replace(/\.?0+$/, '');
                        } catch (e) {
                            decimalResult = result.toString();
                        }
                        
                        showResults(fractionResult, decimalResult, 'fraction-result', 'decimal-result');
                        recordHistory(input, fractionResult + '|' + decimalResult, 'calc');
                        renderExpression(kaTeXOutput);

                    } catch (error) {
                        showResults('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: ' + error.message, '---', 'error', 'error');
                    }
                }
            }
        }

        // --- –ö–æ–¥ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π solveCubic, solveCubicAlternative, solveEquation –∏ parseSide –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å, 
        // –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ, –Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–ø—É—â–µ–Ω. ---
        
        // ... (–§—É–Ω–∫—Ü–∏–∏ solveCubic, solveCubicAlternative, solveEquation –∏ parseSide)
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        renderHistory();
        renderExpression(expressionInput.value);
    </script>
</body>
                    </html>
