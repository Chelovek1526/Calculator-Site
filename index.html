<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #111827);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        .calculator-container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
        }
        .calculator {
            background: #374151;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
            display: flex;
            flex-direction: column;
        }
        #render-output {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            min-height: 60px;
            margin-bottom: 10px;
            text-align: right;
            font-size: 1.8rem;
            color: #d1d5db;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            overflow-x: auto;
        }
        #result-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin-bottom: 15px;
        }
        .result-box {
            padding: 10px;
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: right;
            word-break: break-all;
            background-color: #1f2937;
            border-left: 4px solid;
        }
        .result-box.fraction-result { color: #10b981; border-color: #10b981; }
        .result-box.decimal-result { color: #3b82f6; border-color: #3b82f6; }
        .error { color: #f87171; border-color: #f87171; }
        .text-purple-400 { color: #c084fc; border-color: #c084fc; }
        .text-yellow-400 { color: #facc15; border-color: #facc15; }
        .text-orange-400 { color: #fb923c; border-color: #fb923c; }
        .converter-panel {
            background: #28303d;
            width: 100%;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
            margin-top: 20px;
            color: #d1d5db;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s;
            max-height: 450px;
            overflow-y: auto;
        }
        .converter-panel.hidden {
            max-height: 0;
            padding: 0;
            opacity: 0;
            visibility: hidden;
        }
        .converter-section {
            padding: 10px;
            border: 1px solid #4b5563;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .converter-input, .converter-select {
            background: #1f2937;
            color: #d1d5db;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 8px;
            width: 100%;
            margin-top: 5px;
        }
        input[type="text"] {
            width: 100%;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            background: #1f2937;
            color: #d1d5db;
            text-align: right;
            transition: all 0.2s;
        }
        input[type="text"].error {
            border: 2px solid #f87171;
            box-shadow: 0 0 0 1px #f87171;
        }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-op { background-color: #f59e0b; color: #1f2937; box-shadow: 0 3px #d97706; }
        .btn-op:active { background-color: #d97706; transform: translateY(1px); box-shadow: 0 2px #d97706; }
        .btn-num { background-color: #4b5563; color: white; box-shadow: 0 3px #374151; }
        .btn-num:active { background-color: #374151; transform: translateY(1px); box-shadow: 0 2px #374151; }
        .btn-main { background-color: #10b981; color: white; box-shadow: 0 3px #059669; grid-column: span 4; }
        .btn-main:active { background-color: #059669; transform: translateY(1px); box-shadow: 0 2px #059669; }
        .btn-clear, .btn-history { background-color: #ef4444; color: white; box-shadow: 0 3px #dc2626; }
        .btn-clear:active, .btn-history:active { background-color: #dc2626; transform: translateY(1px); box-shadow: 0 2px #dc2626; }
        .btn-mem { background-color: #3b82f6; color: white; box-shadow: 0 3px #2563eb; }
        .btn-mem:active { background-color: #2563eb; transform: translateY(1px); box-shadow: 0 2px #2563eb; }
        .btn-percent { background-color: #8b5cf6; color: white; box-shadow: 0 3px #7c3aed; }
        .btn-percent:active { background-color: #7c3aed; transform: translateY(1px); box-shadow: 0 2px #7c3aed; }
        .history-panel {
            background: #28303d;
            width: 100%;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #4b5563;
            max-height: 400px;
            overflow-y: auto;
            color: #d1d5db;
            margin-top: 20px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, visibility 0.3s;
        }
        .history-panel.hidden {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            visibility: hidden;
        }
        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s;
            border-left: 4px solid #f59e0b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover { background: #4b5563; }
        .history-content { flex: 1; }
        .history-expression { font-size: 0.9rem; color: #9ca3af; }
        .history-result { font-size: 1.2rem; font-weight: 600; color: #10b981; }
        .history-actions { display: flex; gap: 5px; }
        .history-action-btn {
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
        }
        .history-action-btn:hover { background: rgba(255,255,255,0.1); }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #374151;
            padding: 20px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #d1d5db;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 10px;
        }
        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
        }
        .close-btn:hover { color: #fff; }
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }
        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 5px solid #4b5563;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 500px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .language-select {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 5px 10px;
        }
        .precision-slider {
            width: 100%;
            height: 6px;
            background: #4b5563;
            outline: none;
            border-radius: 3px;
        }
        .precision-slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        
        /* AI Response —Å—Ç–∏–ª–∏ */
        #ai-response {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        #ai-response code {
            background: rgba(59, 130, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        #ai-response .math {
            color: #10b981;
            font-weight: bold;
        }
        #ai-response .error {
            color: #f87171;
            border-left: 3px solid #f87171;
            padding-left: 10px;
        }
        #ai-response .success {
            color: #10b981;
            border-left: 3px solid #10b981;
            padding-left: 10px;
        }
        .ai-thinking {
            animation: pulse 1.5s infinite;
            text-align: center;
            padding: 40px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .ai-message {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3b82f6;
        }
        .ai-message.user {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .ai-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-action-btn.copy {
            background: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }
        .ai-action-btn.copy:hover {
            background: #4b5563;
        }
        .ai-action-btn.insert {
            background: #059669;
            color: white;
            border: none;
        }
        .ai-action-btn.insert:hover {
            background: #047857;
        }
        .ai-action-btn.clear {
            background: #dc2626;
            color: white;
            border: none;
        }
        .ai-action-btn.clear:hover {
            background: #b91c1c;
        }
        .ai-model-select {
            background: #1f2937;
            color: #d1d5db;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        .api-key-status {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #ef4444;
            color: white;
            margin-left: 10px;
        }
        .api-key-status.active {
            background: #10b981;
        }
        .offline-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #6b7280;
            color: white;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="spinner" id="spinner">
        <div class="spinner-circle"></div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–º–æ—â–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold" id="help-title">üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É</h2>
                <button class="close-btn" onclick="closeModal('helpModal')">√ó</button>
            </div>
            <div class="space-y-4">
                <div><h3 class="text-lg font-bold text-blue-300 mb-2">–ü—Ä–æ—Ü–µ–Ω—Ç—ã (–∫–∞–∫ –≤ Samsung)</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><code>100%50</code> ‚Üí 50 (50% –æ—Ç 100)</li>
                        <li><code>200+10%</code> ‚Üí 220 (200 + 10% –æ—Ç 200)</li>
                        <li><code>500-20%</code> ‚Üí 400 (500 - 20% –æ—Ç 500)</li>
                        <li><code>1000*15%</code> ‚Üí 150 (15% –æ—Ç 1000)</li>
                        <li><code>80/20%</code> ‚Üí 400 (80 √∑ 20%)</li>
                    </ul>
                </div>
                <!-- ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ ... -->
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div class="modal" id="graphModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold" id="graph-title">üìà –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞</h2>
                <button class="close-btn" onclick="closeModal('graphModal')">√ó</button>
            </div>
            <div class="mb-4">
                <label class="block mb-2" id="graph-function-label">–§—É–Ω–∫—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ x –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é):</label>
                <input type="text" id="graph-function" class="w-full p-2 rounded bg-gray-800 text-white" value="x^2" placeholder="sin(x), x^2, log(x)">
            </div>
            <!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ ... -->
        </div>
    </div>
    
    <!-- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø AI –ú–û–î–ê–õ–ö–ê - –¢–ï–ü–ï–†–¨ –û–§–§–õ–ê–ô–ù -->
    <div class="modal" id="aiModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="text-2xl font-bold" id="ai-title">üß† –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ü–æ–º–æ—â–Ω–∏–∫ <span class="offline-badge">–û–§–§–õ–ê–ô–ù</span></h2>
                <button class="close-btn" onclick="closeModal('aiModal')">√ó</button>
            </div>
            <div class="mb-4">
                <label class="block mb-2" for="ai-prompt">–ó–∞–¥–∞–π—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É:</label>
                <textarea id="ai-prompt" class="w-full p-3 rounded bg-gray-800 text-white h-32" 
                          placeholder="–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ 2+2
‚Ä¢ x+5=10
‚Ä¢ 15% –æ—Ç 200
‚Ä¢ –ø–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ —Ä–∞–¥–∏—É—Å–æ–º 5
‚Ä¢ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –æ—Ç x^2"></textarea>
            </div>
            
            <div class="mb-4 p-3 bg-blue-900/30 rounded border border-blue-700">
                <p class="text-sm text-blue-300">üí° <strong>–û—Ñ—Ñ–ª–∞–π–Ω –ø–æ–º–æ—â–Ω–∏–∫</strong> - —Ä–µ—à–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞!</p>
                <p class="text-xs text-blue-400 mt-1">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫—É, —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –≥–µ–æ–º–µ—Ç—Ä–∏—é</p>
            </div>
            
            <div class="mb-4 flex items-center gap-4">
                <select id="ai-model" class="ai-model-select" disabled>
                    <option>üîí –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</option>
                </select>
                <button onclick="askAI()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2" id="ai-ask-btn">
                    <span id="ai-btn-text">–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É</span>
                    <span id="ai-loading" class="hidden">‚è≥</span>
                </button>
                <span id="api-status" class="api-key-status">üö´ API –Ω–µ –Ω—É–∂–µ–Ω</span>
            </div>
            
            <div class="mb-4">
                <label class="block mb-2 text-sm text-gray-400">–ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞:</label>
                <div class="p-3 bg-gray-900 rounded text-sm">
                    <div class="flex justify-between mb-2">
                        <span>–¢–µ–∫—É—â–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: <code id="current-expression-context">–Ω–µ—Ç</code></span>
                        <button onclick="useCurrentExpression()" class="text-xs text-blue-400 hover:text-blue-300">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                    </div>
                    <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <code id="last-result-context">–Ω–µ—Ç</code></div>
                </div>
            </div>
            
            <div id="ai-response" class="p-4 bg-gray-900 rounded min-h-48">
                <div class="ai-thinking">
                    <div class="text-2xl mb-2">üßÆ</div>
                    <p>–û—Ñ—Ñ–ª–∞–π–Ω –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫</p>
                    <p class="text-sm text-gray-400 mt-2">–†–µ—à–∞–µ—Ç –∑–∞–¥–∞—á–∏ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ API –∫–ª—é—á–µ–π!</p>
                </div>
            </div>
            
            <div class="ai-actions mt-4">
                <button onclick="copyAIResponse()" class="ai-action-btn copy" id="ai-copy-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="insertAIResult()" class="ai-action-btn insert" id="ai-insert-btn">‚û°Ô∏è –í—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
                <button onclick="clearAIResponse()" class="ai-action-btn clear" id="ai-clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            
            <div class="mt-4 text-xs text-gray-400">
                <p>üí° <strong>–°–æ–≤–µ—Ç:</strong> –í–≤–µ–¥–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.</p>
                <p class="mt-1">‚úÖ <strong>–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω</strong> - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–µ–π –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</p>
            </div>
        </div>
    </div>
    
    <!-- Header —Å –∫–Ω–æ–ø–∫–æ–π AI -->
    <div class="header-controls">
        <h1 class="text-3xl font-extrabold text-white">üßÆ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
        <div class="flex gap-2">
            <button onclick="openModal('aiModal')" class="px-3 py-1 bg-purple-700 text-white rounded hover:bg-purple-600 flex items-center gap-1">
                üß† –ü–æ–º–æ—â–Ω–∏–∫
            </button>
            <button onclick="openModal('helpModal')" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-600">?</button>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div class="calculator-container">
        <div class="calculator">
            <div id="result-container">
                <div class="result-box fraction-result" id="fraction-result" data-i18n="exact_answer">–¢–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç: –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞...</div>
                <div class="result-box decimal-result" id="decimal-result" data-i18n="approx_answer">–ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ---</div>
            </div>
            <div id="render-output"></div>
            <input type="text" id="expression" placeholder="–í–≤–µ–¥–∏—Ç–µ: 100%50, 200+10%, x+5=10, 3/4*2" autocomplete="off">
            
            <!-- –ö–Ω–æ–ø–∫–∏ –ø–∞–º—è—Ç–∏ -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button class="btn-mem text-sm" onclick="memoryClear()">MC</button>
                <button class="btn-mem text-sm" onclick="memoryRecall()">MR</button>
                <button class="btn-mem text-sm" onclick="memoryAdd()">M+</button>
                <button class="btn-mem text-sm" onclick="memorySubtract()">M-</button>
            </div>
            
            <!-- –ù–∞—É—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
            <div class="grid grid-cols-5 gap-2 mb-4">
                <button class="btn-op text-sm" onclick="appendToExpression('sin(')">sin</button>
                <button class="btn-op text-sm" onclick="appendToExpression('cos(')">cos</button>
                <button class="btn-op text-sm" onclick="appendToExpression('tan(')">tan</button>
                <button class="btn-op text-sm" onclick="appendToExpression('log(')">log</button>
                <button class="btn-op text-sm" onclick="appendToExpression('sqrt(')">‚àö</button>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
            <div class="btn-grid">
                <button class="btn-history" onclick="toggleConverter()">üåê</button>
                <button class="btn-history" onclick="toggleHistory()">H</button>
                <button class="btn-clear" onclick="clearExpression()">AC</button>
                <button class="btn-op" onclick="appendToExpression('(')">(</button>
                <button class="btn-op" onclick="appendToExpression(')')">)</button>
                <button class="btn-num" onclick="appendToExpression('7')">7</button>
                <button class="btn-num" onclick="appendToExpression('8')">8</button>
                <button class="btn-num" onclick="appendToExpression('9')">9</button>
                <button class="btn-op" onclick="appendToExpression('/')">/</button>
                <button class="btn-num" onclick="appendToExpression('4')">4</button>
                <button class="btn-num" onclick="appendToExpression('5')">5</button>
                <button class="btn-num" onclick="appendToExpression('6')">6</button>
                <button class="btn-op" onclick="appendToExpression('*')">√ó</button>
                <button class="btn-num" onclick="appendToExpression('1')">1</button>
                <button class="btn-num" onclick="appendToExpression('2')">2</button>
                <button class="btn-num" onclick="appendToExpression('3')">3</button>
                <button class="btn-op" onclick="appendToExpression('-')">-</button>
                <button class="btn-num" onclick="appendToExpression('0')">0</button>
                <button class="btn-num" onclick="appendToExpression('.')">.</button>
                <button class="btn-op" onclick="appendToExpression('\\pi')">œÄ</button>
                <button class="btn-percent" onclick="appendToExpression('%')">%</button>
                <button class="btn-op" onclick="appendToExpression('i')">i</button>
                <button class="btn-op" onclick="openModal('graphModal')">üìà</button>
                <button class="btn-op" onclick="appendToExpression('^')">^</button>
                <button class="btn-op" onclick="appendToExpression('=')">=</button>
                <button class="btn-main mt-4" onclick="handleInput()" id="calculate-btn" data-i18n="calculate">–í—ã—á–∏—Å–ª–∏—Ç—å</button>
            </div>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="mt-4 pt-4 border-t border-gray-600 flex justify-between items-center">
                <select id="language-select" class="language-select" onchange="changeLanguage()">
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="en">üá∫üá∏ English</option>
                </select>
                <label class="flex items-center gap-2 text-white">
                    <span id="scientific-label" data-i18n="scientific_label">–ù–∞—É—á–Ω–∞—è</span>
                    <label class="switch"><input type="checkbox" id="scientific-toggle" onchange="toggleScientificNotation()"><span class="slider"></span></label>
                </label>
            </div>
        </div>
        
        <!-- –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∏ –∏—Å—Ç–æ—Ä–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
        <div class="converter-panel hidden" id="converter-panel">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2" data-i18n="unit_converter">üåê –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ï–¥–∏–Ω–∏—Ü</h3>
            <!-- ... –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä ... -->
        </div>
        
        <div class="history-panel hidden" id="history-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold border-b border-gray-600 pb-2" data-i18n="calculation_history">–ñ—É—Ä–Ω–∞–ª –í—ã—á–∏—Å–ª–µ–Ω–∏–π</h3>
                <!-- ... –∏—Å—Ç–æ—Ä–∏—è ... -->
            </div>
        </div>
    </div>

    <script>
        // ===== –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        const expressionInput = document.getElementById('expression');
        const fractionResultDiv = document.getElementById('fraction-result');
        const decimalResultDiv = document.getElementById('decimal-result');
        const historyPanel = document.getElementById('history-panel');
        const historyLogDiv = document.getElementById('history-log');
        const renderOutputDiv = document.getElementById('render-output');
        const converterPanel = document.getElementById('converter-panel');
        const converterResultOutput = document.getElementById('converter-result-output');
        const spinner = document.getElementById('spinner');
        const precisionSlider = document.getElementById('precision-slider');
        const precisionValue = document.getElementById('precision-value');
        const languageSelect = document.getElementById('language-select');
        
        let calculationHistory = [];
        let memoryValue = 0;
        let precision = 6;
        let scientificNotation = false;
        let historyIndex = -1;
        let originalExpression = '';
        const Epsilon = 1e-10;
        let currentLanguage = 'ru';
        
        // –ë–û–õ–¨–®–ï –ù–ï–¢ API –ö–õ–Æ–ß–ê!
        let aiRequestsCount = 0;
        let aiHistory = [];
        
        // ===== –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô –î–õ–Ø –û–§–§–õ–ê–ô–ù AI =====
        const mathKnowledgeBase = {
            // –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞
            '2+2': '2 + 2 = 4',
            '3+3': '3 + 3 = 6',
            '4+4': '4 + 4 = 8',
            '5+5': '5 + 5 = 10',
            '10+10': '10 + 10 = 20',
            
            // –£—Ä–∞–≤–Ω–µ–Ω–∏—è
            'x+5=10': 'x + 5 = 10\nx = 10 - 5\nx = 5',
            'x-3=7': 'x - 3 = 7\nx = 7 + 3\nx = 10',
            '2x=8': '2x = 8\nx = 8 √∑ 2\nx = 4',
            'x/2=6': 'x √∑ 2 = 6\nx = 6 √ó 2\nx = 12',
            'x^2=9': 'x¬≤ = 9\nx = ‚àö9\nx = 3 –∏–ª–∏ x = -3',
            
            // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
            '15% –æ—Ç 200': '15% –æ—Ç 200 = 200 √ó 0.15 = 30',
            '10% –æ—Ç 100': '10% –æ—Ç 100 = 100 √ó 0.10 = 10',
            '25% –æ—Ç 80': '25% –æ—Ç 80 = 80 √ó 0.25 = 20',
            '50% –æ—Ç 60': '50% –æ—Ç 60 = 60 √ó 0.50 = 30',
            '100% –æ—Ç 45': '100% –æ—Ç 45 = 45 √ó 1.00 = 45',
            
            // –ì–µ–æ–º–µ—Ç—Ä–∏—è
            '–ø–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ —Ä–∞–¥–∏—É—Å–æ–º 5': 'S = œÄr¬≤ = œÄ √ó 5¬≤ = 25œÄ ‚âà 78.54',
            '–ø–ª–æ—â–∞–¥—å –∫–≤–∞–¥—Ä–∞—Ç–∞ —Å—Ç–æ—Ä–æ–Ω–æ–π 4': 'S = a¬≤ = 4¬≤ = 16',
            '–ø–ª–æ—â–∞–¥—å —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ 6 –≤—ã—Å–æ—Ç–∞ 4': 'S = ¬Ω √ó –æ—Å–Ω–æ–≤–∞–Ω–∏–µ √ó –≤—ã—Å–æ—Ç–∞ = ¬Ω √ó 6 √ó 4 = 12',
            '–ø–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ —Å—Ç–æ—Ä–æ–Ω–æ–π 5': 'P = 4a = 4 √ó 5 = 20',
            '–æ–±—ä–µ–º –∫—É–±–∞ —Å—Ç–æ—Ä–æ–Ω–æ–π 3': 'V = a¬≥ = 3¬≥ = 27',
            
            // –ê–ª–≥–µ–±—Ä–∞
            '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –æ—Ç x^2': 'f(x) = x¬≤\nf\'(x) = 2x',
            '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –æ—Ç x^3': 'f(x) = x¬≥\nf\'(x) = 3x¬≤',
            '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –æ—Ç sin(x)': 'f(x) = sin(x)\nf\'(x) = cos(x)',
            '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –æ—Ç cos(x)': 'f(x) = cos(x)\nf\'(x) = -sin(x)',
            '–∏–Ω—Ç–µ–≥—Ä–∞–ª –æ—Ç x': '‚à´x dx = ¬Ωx¬≤ + C',
            
            // –§–∏–∑–∏–∫–∞
            '—Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ 100 –≤—Ä–µ–º—è 20': 'v = s/t = 100 √∑ 20 = 5 –º/—Å',
            '—Å–∏–ª–∞ –º–∞—Å—Å–∞ 10 —É—Å–∫–æ—Ä–µ–Ω–∏–µ 2': 'F = m √ó a = 10 √ó 2 = 20 –ù',
            '—Ä–∞–±–æ—Ç–∞ —Å–∏–ª–∞ 5 —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ 3': 'A = F √ó s = 5 √ó 3 = 15 –î–∂',
            '–ø–ª–æ—Ç–Ω–æ—Å—Ç—å –º–∞—Å—Å–∞ 30 –æ–±—ä–µ–º 6': 'œÅ = m/V = 30 √∑ 6 = 5 –≥/—Å–º¬≥',
            
            // –û–±—â–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç—ã
            '–ø–∏': 'œÄ ‚âà 3.141592653589793',
            '–µ': 'e ‚âà 2.718281828459045',
            '–≥—Ä–∞–¥—É—Å –≤ —Ä–∞–¥–∏–∞–Ω—ã': '1¬∞ = œÄ/180 ‚âà 0.01745 —Ä–∞–¥',
            '—Ä–∞–¥–∏–∞–Ω –≤ –≥—Ä–∞–¥—É—Å—ã': '1 —Ä–∞–¥ = 180/œÄ ‚âà 57.2958¬∞',
            '—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª 5': '5! = 5 √ó 4 √ó 3 √ó 2 √ó 1 = 120'
        };
        
        const translations = {
            ru: {
                exact_answer: "–¢–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç: ",
                approx_answer: "–ü—Ä–∏–±–ª–∏–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ",
                calculate: "–í—ã—á–∏—Å–ª–∏—Ç—å",
                unit_converter: "üåê –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –ï–¥–∏–Ω–∏—Ü",
                select_category: "–í—ã–±–µ—Ä–∏—Ç–µ –ö–∞—Ç–µ–≥–æ—Ä–∏—é:",
                value: "–ó–Ω–∞—á–µ–Ω–∏–µ:",
                from: "–ò–ó:",
                to: "–í:",
                precision: "–¢–æ—á–Ω–æ—Å—Ç—å (–∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π):",
                result: "–†–µ–∑—É–ª—å—Ç–∞—Ç: ",
                calculation_history: "–ñ—É—Ä–Ω–∞–ª –í—ã—á–∏—Å–ª–µ–Ω–∏–π",
                export: "–≠–∫—Å–ø–æ—Ä—Ç",
                clear_all: "–£–¥–∞–ª–∏—Ç—å –≤—Å—ë",
                history_empty: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.",
                scientific_label: "–ù–∞—É—á–Ω–∞—è",
                expression_placeholder: "–í–≤–µ–¥–∏—Ç–µ: 100%50, 200+10%, x+5=10, 3/4*2",
                conversion: "–ö–æ–Ω–≤–µ—Ä—Å–∏—è",
                memory_cleared: "–ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞",
                memory_value: "–ó–Ω–∞—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: ",
                memory_add_error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –ø–∞–º—è—Ç—å: ",
                memory_sub_error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Ç–∞–Ω–∏–∏ –∏–∑ –ø–∞–º—è—Ç–∏: ",
                confirm_clear_history: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?",
                history_cleared: "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞",
                history_exported: "–ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞",
                no_history: "–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞",
                graph_function: "–§—É–Ω–∫—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ x –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é):",
                graph_from: "–û—Ç:",
                graph_to: "–î–æ:",
                graph_step: "–®–∞–≥:",
                plot_graph: "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫",
                –î–ª–∏–Ω–∞: "–î–ª–∏–Ω–∞",
                –ú–∞—Å—Å–∞: "–ú–∞—Å—Å–∞",
                –û–±—ä–µ–º: "–û–±—ä–µ–º",
                –ü–ª–æ—â–∞–¥—å: "–ü–ª–æ—â–∞–¥—å",
                –í—Ä–µ–º—è: "–í—Ä–µ–º—è",
                –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
                –°–∫–æ—Ä–æ—Å—Ç—å: "–°–∫–æ—Ä–æ—Å—Ç—å",
                '–≠–Ω–µ—Ä–≥–∏—è/–†–∞–±–æ—Ç–∞': "–≠–Ω–µ—Ä–≥–∏—è/–†–∞–±–æ—Ç–∞",
                –î–∞–≤–ª–µ–Ω–∏–µ: "–î–∞–≤–ª–µ–Ω–∏–µ",
                –°–∏–ª–∞: "–°–∏–ª–∞",
                'help_title': "üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É",
                'graph_title': "üìà –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞",
                'ai_title': "üß† –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ü–æ–º–æ—â–Ω–∏–∫",
                'ai_ask_btn': "–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É",
                'ai_processing': "–†–µ—à–µ–Ω–∏–µ...",
                'ai_copy_btn': "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                'ai_insert_btn': "‚û°Ô∏è –í—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
                'ai_clear_btn': "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å"
            },
            en: {
                exact_answer: "Exact answer: ",
                approx_answer: "Approximate answer: ",
                calculate: "Calculate",
                unit_converter: "üåê Unit Converter",
                select_category: "Select Category:",
                value: "Value:",
                from: "FROM:",
                to: "TO:",
                precision: "Precision (decimal places):",
                result: "Result: ",
                calculation_history: "Calculation History",
                export: "Export",
                clear_all: "Clear All",
                history_empty: "Results will appear here.",
                scientific_label: "Scientific",
                expression_placeholder: "Enter: 100%50, 200+10%, x+5=10, 3/4*2",
                conversion: "Conversion",
                memory_cleared: "Memory cleared",
                memory_value: "Memory value: ",
                memory_add_error: "Error adding to memory: ",
                memory_sub_error: "Error subtracting from memory: ",
                confirm_clear_history: "Are you sure you want to clear all history?",
                history_cleared: "History cleared",
                history_exported: "History exported",
                no_history: "No history to export",
                graph_function: "Function (use x as variable):",
                graph_from: "From:",
                graph_to: "To:",
                graph_step: "Step:",
                plot_graph: "Plot Graph",
                –î–ª–∏–Ω–∞: "Length",
                –ú–∞—Å—Å–∞: "Mass",
                –û–±—ä–µ–º: "Volume",
                –ü–ª–æ—â–∞–¥—å: "Area",
                –í—Ä–µ–º—è: "Time",
                –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: "Temperature",
                –°–∫–æ—Ä–æ—Å—Ç—å: "Speed",
                '–≠–Ω–µ—Ä–≥–∏—è/–†–∞–±–æ—Ç–∞': "Energy/Work",
                –î–∞–≤–ª–µ–Ω–∏–µ: "Pressure",
                –°–∏–ª–∞: "Force",
                'help_title': "üìö Calculator Help",
                'graph_title': "üìà Plot Graph",
                'ai_title': "üß† Math Assistant",
                'ai_ask_btn': "Solve Problem",
                'ai_processing': "Solving...",
                'ai_copy_btn': "üìã Copy",
                'ai_insert_btn': "‚û°Ô∏è Insert to Calculator",
                'ai_clear_btn': "üóëÔ∏è Clear"
            }
        };
        
        const UNIT_CATEGORIES = {
            '–î–ª–∏–Ω–∞': ['m', 'km', 'cm', 'mm', 'inch', 'ft', 'yd', 'mile'],
            '–ú–∞—Å—Å–∞': ['kg', 'g', 'mg', 'lbm', 'oz', 'tonne'],
            '–û–±—ä–µ–º': ['m^3', 'L', 'mL', 'gallon', 'quart', 'pint'],
            '–ü–ª–æ—â–∞–¥—å': ['m^2', 'km^2', 'cm^2', 'acre', 'ha'],
            '–í—Ä–µ–º—è': ['s', 'min', 'hr', 'day', 'week', 'year'],
            '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': ['degC', 'degF', 'K'],
            '–°–∫–æ—Ä–æ—Å—Ç—å': ['m/s', 'km/h', 'mph', 'knot'],
            '–≠–Ω–µ—Ä–≥–∏—è/–†–∞–±–æ—Ç–∞': ['J', 'kJ', 'cal', 'kcal', 'kWh', 'BTU'],
            '–î–∞–≤–ª–µ–Ω–∏–µ': ['Pa', 'kPa', 'bar', 'atm', 'psi'],
            '–°–∏–ª–∞': ['N', 'kN', 'lbf'],
        };
        
        const scope = { M: 0, pi: math.pi, e: math.e, i: math.i };
        Object.defineProperty(scope, 'M', {
            get: () => memoryValue, set: (val) => memoryValue = val, enumerable: true, configurable: true
        });
        
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        function init() {
            calculationHistory = [];
            memoryValue = 0;
            precision = 6;
            scientificNotation = false;
            currentLanguage = 'ru';
            
            precisionSlider.value = precision;
            document.getElementById('scientific-toggle').checked = scientificNotation;
            languageSelect.value = currentLanguage;
            
            initConverter();
            renderExpression('');
            updatePrecision();
            updateLanguage();
        }
        
        // ===== –û–§–§–õ–ê–ô–ù AI –ü–û–ú–û–©–ù–ò–ö =====
        function askAI() {
            const prompt = document.getElementById('ai-prompt').value.trim().toLowerCase();
            
            if (!prompt) {
                alert('–í–≤–µ–¥–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å');
                return;
            }
            
            const askBtn = document.getElementById('ai-ask-btn');
            const loading = document.getElementById('ai-loading');
            const responseDiv = document.getElementById('ai-response');
            const btnText = document.getElementById('ai-btn-text');
            
            askBtn.disabled = true;
            loading.classList.remove('hidden');
            btnText.textContent = translations[currentLanguage].ai_processing;
            
            responseDiv.innerHTML = '<div class="ai-thinking">ü§î –†–µ—à–∞—é –∑–∞–¥–∞—á—É...</div>';
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                try {
                    const solution = solveMathProblem(prompt);
                    displayAIResponse(solution);
                    aiRequestsCount++;
                    
                } catch (error) {
                    responseDiv.innerHTML = `
                        <div class="error p-4">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á—É<br><br>
                            <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ø—Ä—è–º—É—é.</small>
                        </div>
                    `;
                } finally {
                    askBtn.disabled = false;
                    loading.classList.add('hidden');
                    btnText.textContent = translations[currentLanguage].ai_ask_btn;
                }
            }, 800); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
        }
        
        function solveMathProblem(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
            for (const [key, solution] of Object.entries(mathKnowledgeBase)) {
                if (lowerPrompt.includes(key.toLowerCase())) {
                    return `‚úÖ –†–µ—à–µ–Ω–∏–µ –¥–ª—è "${key}":\n\n${solution}`;
                }
            }
            
            // 2. –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏
            if (lowerPrompt.includes('+') || lowerPrompt.includes('-') || 
                lowerPrompt.includes('*') || lowerPrompt.includes('/') ||
                lowerPrompt.includes('—Ä–∞–∑–¥–µ–ª–∏—Ç—å') || lowerPrompt.includes('—É–º–Ω–æ–∂') ||
                lowerPrompt.includes('—Å–ª–æ–∂') || lowerPrompt.includes('–≤—ã—á')) {
                
                try {
                    // –ü—Ä–æ–±—É–µ–º –≤—ã—á–∏—Å–ª–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
                    const result = math.evaluate(prompt.replace(/[^0-9+\-*/.()]/g, ''));
                    return `‚úÖ –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ:\n\n${prompt} = ${result}`;
                } catch (e) {
                    // –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å
                }
            }
            
            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏—è
            if (lowerPrompt.includes('=') && (lowerPrompt.includes('x') || lowerPrompt.includes('—É'))) {
                const equation = prompt.replace(/[^0-9x=+\-*/]/g, '');
                if (equation.includes('x')) {
                    return `‚úÖ –£—Ä–∞–≤–Ω–µ–Ω–∏–µ:\n\n${equation}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–µ—à–µ–Ω–∏—è (–≤–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ–ª–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞).`;
                }
            }
            
            // 4. –ü—Ä–æ—Ü–µ–Ω—Ç—ã
            if (lowerPrompt.includes('%') || lowerPrompt.includes('–ø—Ä–æ—Ü–µ–Ω—Ç')) {
                const match = prompt.match(/(\d+)\s*%\s*(?:–æ—Ç|of)\s*(\d+)/i);
                if (match) {
                    const percent = parseInt(match[1]);
                    const number = parseInt(match[2]);
                    const result = (number * percent) / 100;
                    return `‚úÖ ${percent}% –æ—Ç ${number}:\n\n${percent}% √ó ${number} = ${percent/100} √ó ${number} = ${result}`;
                }
            }
            
            // 5. –ì–µ–æ–º–µ—Ç—Ä–∏—è
            if (lowerPrompt.includes('–ø–ª–æ—â–∞–¥—å') || lowerPrompt.includes('area') ||
                lowerPrompt.includes('–æ–±—ä–µ–º') || lowerPrompt.includes('volume') ||
                lowerPrompt.includes('–ø–µ—Ä–∏–º–µ—Ç—Ä') || lowerPrompt.includes('perimeter')) {
                
                if (lowerPrompt.includes('–∫—Ä—É–≥') || lowerPrompt.includes('circle')) {
                    const radiusMatch = prompt.match(/(\d+)/);
                    if (radiusMatch) {
                        const r = parseInt(radiusMatch[1]);
                        const area = Math.PI * r * r;
                        return `‚úÖ –ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ —Ä–∞–¥–∏—É—Å–æ–º ${r}:\n\nS = œÄr¬≤ = œÄ √ó ${r}¬≤ = ${area.toFixed(2)}`;
                    }
                } else if (lowerPrompt.includes('–∫–≤–∞–¥—Ä–∞—Ç') || lowerPrompt.includes('square')) {
                    const sideMatch = prompt.match(/(\d+)/);
                    if (sideMatch) {
                        const a = parseInt(sideMatch[1]);
                        const area = a * a;
                        const perimeter = 4 * a;
                        return `‚úÖ –ö–≤–∞–¥—Ä–∞—Ç —Å–æ —Å—Ç–æ—Ä–æ–Ω–æ–π ${a}:\n\n–ü–ª–æ—â–∞–¥—å = a¬≤ = ${a}¬≤ = ${area}\n–ü–µ—Ä–∏–º–µ—Ç—Ä = 4a = 4 √ó ${a} = ${perimeter}`;
                    }
                }
            }
            
            // 6. –û–±—â–∏–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏
            return `ü§î –ó–∞–¥–∞—á–∞: "${prompt}"\n\nüí° –°–æ–≤–µ—Ç:\n1. –í–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ø—Ä—è–º—É—é\n2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π\n3. –î–ª—è —É—Ä–∞–≤–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: x+5=10\n\nüîß –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —É–º–µ–µ—Ç:\n- –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\n- –ü—Ä–æ—Ü–µ–Ω—Ç—ã (—Å—Ç–∏–ª—å Samsung)\n- –£—Ä–∞–≤–Ω–µ–Ω–∏—è\n- –î—Ä–æ–±–∏\n- –ù–∞—É—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏`;
        }
        
        function displayAIResponse(response) {
            const responseDiv = document.getElementById('ai-response');
            const formattedResponse = response.replace(/\n/g, '<br>');
            
            const timestamp = new Date().toLocaleTimeString();
            const finalHTML = `
                <div class="mb-4 text-sm text-gray-400 border-b border-gray-700 pb-2">
                    ‚úÖ –†–µ—à–µ–Ω–æ –≤ ${timestamp} | –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
                </div>
                <div class="ai-content">${formattedResponse}</div>
            `;
            
            responseDiv.innerHTML = finalHTML;
            responseDiv.scrollTop = 0;
        }
        
        function copyAIResponse() {
            const responseDiv = document.getElementById('ai-response');
            const text = responseDiv.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('ai-copy-btn');
                const original = btn.textContent;
                btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    btn.textContent = translations[currentLanguage].ai_copy_btn;
                }, 2000);
            });
        }
        
        function insertAIResult() {
            const responseDiv = document.getElementById('ai-response');
            const text = responseDiv.innerText;
            
            // –ò—â–µ–º —á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ
            const matches = text.match(/(?:=|—Ä–∞–≤–Ω–æ|—Ä–∞–≤–Ω—è–µ—Ç—Å—è)\s*([0-9.]+)/i) || 
                          text.match(/(\d+(?:\.\d+)?)$/m);
            
            if (matches && matches[1]) {
                expressionInput.value = matches[1];
                renderExpression(matches[1]);
                closeModal('aiModal');
                alert(`‚úÖ –ß–∏—Å–ª–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ: ${matches[1]}`);
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é.');
            }
        }
        
        function clearAIResponse() {
            document.getElementById('ai-response').innerHTML = 
                '<div class="ai-thinking"><div class="text-2xl mb-2">üßÆ</div><p>–û—Ñ—Ñ–ª–∞–π–Ω –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫</p></div>';
            document.getElementById('ai-prompt').value = '';
        }
        
        function updateAIContext() {
            const currentExpr = expressionInput.value || '–Ω–µ—Ç';
            const lastResult = calculationHistory.length > 0 
                ? calculationHistory[calculationHistory.length - 1].result
                : '–Ω–µ—Ç';
            
            document.getElementById('current-expression-context').textContent = currentExpr;
            document.getElementById('last-result-context').textContent = lastResult;
        }
        
        function useCurrentExpression() {
            const currentExpr = expressionInput.value;
            if (currentExpr) {
                document.getElementById('ai-prompt').value = `–†–µ—à–∏: ${currentExpr}`;
            }
        }
        
        // ===== –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ê –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô =====
        // (–ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏–π, —Ä–µ—à–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–π, –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä, –∏—Å—Ç–æ—Ä–∏—è, –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç.–¥.)
        // ... [–í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ï–°–¨ –û–°–¢–ê–í–®–ò–ô–°–Ø –ö–û–î –ò–ó –ü–†–ï–î–´–î–£–©–ï–ô –í–ï–†–°–ò–ò] ...
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = init;
    </script>
</body>
    </html>
